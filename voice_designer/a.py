import gd
import numpy as np
import Encoder
from DECTalk import DECTalk
from fuckshit import *

target_embedding = Encoder.encode("./target.wav")
def f(p):
    global target_embedding

    voice = get_wendy().copy()
    for i, k in enumerate(voice):
        if k == "SX":
            continue

        voice[k] = max(voice[k] + int(p[i]), 0)
    # voice["RI"] = max(voice["RI"] + int(p[1]), 0)

    panphone = ". ".join(PHONEMIC_PANGRAMS)
    setting = voice_to_string(voice)

    DECTalk.say_to_path(f"{setting} {panphone}","./temp.wav")

    embedding = Encoder.encode("./temp.wav")

    val = 1 - np.dot(embedding, target_embedding)
    print(val, setting)

    return val


# l = [-19.59630964,  47.78039257, -26.63744088,  11.66769146,  17.54899662,
#    3.13066151,  12.08866324,   8.1264188,   -9.76811547,  14.14173525,
#   26.66746301,  16.74907331,   3.88164241,   7.90848962, -52.31718428,
#   -6.6901129,  -25.03404812,  -4.10950366,  23.42315475]

# l = [-44.17892057739749, 43.11790565222296, -37.13355522602738, 10.628614807598627, 16.808888471770814, 3.4903468776863784, -0.8063579414597646, -19.708474345935933, -20.399196254540186, 13.844409460530523, 9.25845506830692, 4.370327071548355, 1.6384541761957974, 27.018148814893255, -63.61756931507096, 16.504882037766286, -44.15028492904553, 22.41073984927138, 38.381092222263185]
# l = [-54.82018217535658, 49.29242351401559, -38.0280951165382, 0.7923369910872045, 4.373662644118209, 10.944295782732237, 6.49634796424066, -7.061558694794272, -24.93284210582509, 19.140150602503308, 18.743632742269508, 15.766495273521052, -0.923960619371851, 16.48296301237168, -65.36985627164881, 12.590619550535738, -31.478957772134006, 16.24433473276905, 29.573973269993715]
# l = [-57.552152237801735, 68.02126954504064, -31.400436670790725, -13.58688036456981, 2.1534662193561926, 4.736156401491543, -6.383953717582299, -14.0422093276274, -4.936441829864109, 15.153050711967051, 24.22122063423314, -2.6805337987243507, 3.4148235082947034, 23.297495786688845, -45.48307609991196, 26.612236408556637, -50.18036265430138, 0.9745898316994293, 24.9013660247047]
#
# r = gd.descent(np.array(l), f, momentum_len=3, max_iter = 10, gradient_oversampling = 5)
# print(f"[{", ".join([str(n) for n in r])}]")


# v = "[:dv AP 112 AS 100 B4 280 B5 330 BF 18 BR 17 F4 3300 F5 3650 HR 18 HS 99 LA 0 LX 0 NF 10 PR 100 QU 40 RI 99 SM 30 SR 25 SX 1]"
v = "[:dv AP 137 AS 145 B4 291 B5 2033 BF 0 BR 47 F4 4593 F5 2491 HR 0 HS 114 LA 6 LX 71 NF 21 PR 113 QU 0 RI 86 SM 0 SR 0 SX 0]"
DECTalk.say(v + "this is the voice that my computer thinks sounds most like paul")